<script src="{{ asset('assets/js/bundle.js') }}?ver=3.2.2"></script>
<script src="{{ asset('assets/js/scripts.js') }}?ver=3.2.2"></script>
<script src="{{ asset('assets/js/charts/gd-default.js') }}?ver=3.2.2"></script>
<script src="{{ asset('assets/js/libs/datatable-init-btns.js') }}?ver=3.2.2"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const moneyInputs = document.querySelectorAll('.money-input');

        // Format visuel à chaque frappe
        moneyInputs.forEach(input => {
            input.addEventListener('input', () => {
                let raw = input.value.replace(/\D/g, ''); // Supprime tout sauf les chiffres
                input.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ' '); // Espace insécable
            });
        });

        // Avant soumission, on nettoie les champs
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', () => {
                moneyInputs.forEach(input => {
                    input.value = input.value.replace(/\s/g, '').replace(/[^\d.,]/g, '');
                });
            });
        });
    });
</script>

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
            appId: "21bf691f-ee9d-4d3a-8c40-b15d1a98ebbd",
            safari_web_id: "web.onesignal.auto.5ccade99-0f35-4775-9ae0-5e2c3bfd110b",
            notifyButton: {
                enable: true,
            },
        });
        console.log("OneSignal initialisé");

        // Demande la permission d'envoyer des notifications
        OneSignal.showSlidedownPrompt();

        // Ecoute les changements d’abonnement
        OneSignal.on('subscriptionChange', async (isSubscribed) => {
            console.log('Subscription changed:', isSubscribed);
            if (isSubscribed) {
                const pushToken = await OneSignal.getUserId();
                console.log('Push Token récupéré:', pushToken);
                if (pushToken) {
                    // Envoie le token à ton backend Symfony
                    fetch('/user/api/save-push-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ pushToken })
                    })
                        .then(response => {
                            if (!response.ok) {
                                console.error('Erreur envoi token au backend');
                            } else {
                                console.log('Token envoyé au backend avec succès');
                            }
                        })
                        .catch(err => {
                            console.error('Erreur fetch:', err);
                        });
                }
            }
        });
    });
</script>
